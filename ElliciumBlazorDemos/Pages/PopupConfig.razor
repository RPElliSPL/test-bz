@using ElliciumBlazorDemos.Data
@using ElliciumBlazorDemos.Models.Northwind
@using Microsoft.EntityFrameworkCore
@using Ellicium.Blazor.Rendering

@inherits DbContextPage
@inject IJSRuntime JSRuntime

<ElliciumButton @ref=button Text="@(orderId != null ? "Selected order: " + orderId.ToString() : "Select order")" Click="@(args => popup.ToggleAsync(button.Element))" />

<Popup @ref=popup Lazy=true Open="@OnOpen"
    Style="display:none;position:absolute;height:300px;width:600px;padding:5px;border:var(--rz-panel-border);background-color:var(--rz-panel-background-color);">
    <ElliciumTextBox id="search" Placeholder="Type to search..." Style="width:100%;" @oninput=@(args => searchString = $"{args.Value}") Value="@searchString" />
    <ElliciumDataList @ref=dataList AllowVirtualization=true Data="@orders" TItem="Order" Style="height:100%;overflow:auto;">
        <Template Context="order">
            <ElliciumCard Style="width:100%">
                <ElliciumRow>
                    <ElliciumColumn Size="8" class="rz-text-truncate">
                        <ElliciumBadge BadgeStyle="BadgeStyle.Light" Text=@($"{order.OrderID}") class="me-1" />
                        <b>@(order.ShipName)</b>
                    </ElliciumColumn>
                    <ElliciumColumn Size="4" class="rz-text-align-end">
                        <ElliciumBadge BadgeStyle="BadgeStyle.Success" Text=@($"{String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", order.Freight)}") />
                    </ElliciumColumn>
                </ElliciumRow>
                <hr style="border: none; background-color: var(--rz-text-disabled-color); height: 1px; margin: 1rem 0;" />
                <ElliciumStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <ElliciumImage Path="@order.Employee?.Photo" Style="width: 80px; height: 80px; border-radius: 50%" AlternateText="@(order.Employee?.FirstName + " " + order.Employee?.LastName)" />
                    <ElliciumStack Gap="0">
                        <ElliciumText TextStyle="TextStyle.H6" Class="rz-mb-0">@(order.Employee?.FirstName + " " + order.Employee?.LastName)</ElliciumText>
                        <ElliciumText TextStyle="TextStyle.Body1">@order.ShipAddress</ElliciumText>
                        <ElliciumText TextStyle="TextStyle.Body2">@(order.ShipCity), @(order.ShipCountry)</ElliciumText>
                    </ElliciumStack>
                    <ElliciumButton Text="Select" Click="@(args => SelectOrder(order))" Visible=@(orderId != order.OrderID) />
                </ElliciumStack>
            </ElliciumCard>
        </Template>
    </ElliciumDataList>
</Popup>

@code {
    ElliciumButton button;
    Popup popup;
    ElliciumDataList<Order> dataList;
    IEnumerable<Order> orders;
    int? orderId;
    string searchString = "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        orders = dbContext.Orders.Include("Customer").Include("Employee")
            .Where(o => o.OrderID.ToString().Contains(searchString)
                || o.Customer.CompanyName.ToLowerInvariant().Contains(searchString)
                    || o.Employee.FirstName.ToLowerInvariant().Contains(searchString)
                        || o.Employee.LastName.ToLowerInvariant().Contains(searchString)
                            || o.ShipCity.ToLowerInvariant().Contains(searchString)
                                || o.ShipCountry.ToLowerInvariant().Contains(searchString));
    }

    async Task SelectOrder(Order order)
    {
        orderId = order.OrderID; 
        await popup.CloseAsync();
    }

    async Task OnOpen()
    {
        await JSRuntime.InvokeVoidAsync("eval", "setTimeout(function(){ document.getElementById('search').focus(); }, 200)"); 
    }
}